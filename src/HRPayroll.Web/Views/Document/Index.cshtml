@model IEnumerable<HRPayroll.Domain.Entities.HR.EmployeeDocument>
@{
    ViewData["Title"] = "Employee Documents";
    var employees = ViewBag.Employees as IEnumerable<HRPayroll.Domain.Entities.HR.Employee> ?? Enumerable.Empty<HRPayroll.Domain.Entities.HR.Employee>();
    var categories = ViewBag.Categories as IEnumerable<HRPayroll.Domain.Entities.HR.DocumentCategory> ?? Enumerable.Empty<HRPayroll.Domain.Entities.HR.DocumentCategory>();
}


    <a asp-action="Upload" class="btn btn-success">
        <i class="fas fa-upload"></i> Upload Document
    </a>


<div class="card">
    <div class="card-header">
        <h3 class="card-title">Employee Documents</h3>
    </div>
    <div class="card-body">
        <!-- Filter Form -->
        <form asp-action="Index" method="get" class="mb-4">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Employee</label>
                        <select name="employeeId" class="form-control select2" asp-items='@((employees.Any() ? new SelectList(employees, "Id", "FullName") : null))'>
                            <option value="">All Employees</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Category</label>
                        <select name="categoryId" class="form-control" asp-items='@((categories.Any() ? new SelectList(categories, "Id", "Name") : null))'>
                            <option value="">All Categories</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>Document Type</label>
                        <select name="documentType" class="form-control">
                            <option value="">All Types</option>
                            <option value="PDF">PDF</option>
                            <option value="DOCX">DOCX</option>
                            <option value="JPEG">JPEG</option>
                            <option value="PNG">PNG</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn btn-primary btn-block">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <table id="documentsTable" class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Employee</th>
                    <th>Category</th>
                    <th>Document Name</th>
                    <th>Type</th>
                    <th>Upload Date</th>
                    <th>Expiry Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var doc in Model)
                {
                    <tr>
                        <td>@doc.Employee?.FullName</td>
                        <td>@doc.Category?.Name</td>
                        <td>
                            <strong>@doc.DocumentName</strong>
                            @if (!string.IsNullOrEmpty(doc.Description))
                            {
                                <br /><small class="text-muted">@doc.Description</small>
                            }
                        </td>
                        <td>
                            @{
                                var icon = doc.FileExtension?.ToUpper() switch
                                {
                                    "PDF" => "fa-file-pdf text-danger",
                                    "DOCX" or "DOC" => "fa-file-word text-primary",
                                    "XLSX" or "XLS" => "fa-file-excel text-success",
                                    "JPEG" or "JPG" => "fa-file-image",
                                    "PNG" => "fa-file-image",
                                    _ => "fa-file"
                                };
                            }
                            <i class="fas @icon"></i> @doc.FileExtension?.ToUpper()
                        </td>
                        <td>@doc.CreatedDate?.ToString("dd MMM yyyy")</td>
                        <td>
                            @if (doc.ExpiryDate.HasValue)
                            {
                                var isExpired = doc.ExpiryDate.Value < DateTime.Now;
                                var isExpiringSoon = !isExpired && doc.ExpiryDate.Value <= DateTime.Now.AddDays(30);
                                <span class="@(isExpired ? "text-danger" : isExpiringSoon ? "text-warning" : "")">
                                    @doc.ExpiryDate.Value.ToString("dd MMM yyyy")
                                </span>
                            }
                            else
                            {
                                <span class="text-muted">N/A</span>
                            }
                        </td>
                        <td>
                            @if (doc.IsVerified)
                            {
                                <span class="badge badge-success">Verified</span>
                            }
                            else
                            {
                                <span class="badge badge-warning">Pending</span>
                            }
                        </td>
                        <td>
                            <div class="btn-group">
                                <a asp-action="Download" asp-route-id="@doc.Id" class="btn btn-sm btn-info" title="Download">
                                    <i class="fas fa-download"></i>
                                </a>
                                <a asp-action="EditDocument" asp-route-id="@doc.Id" class="btn btn-sm btn-primary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-danger" title="Delete" 
                                        onclick="confirmDelete(@doc.Id, '@doc.DocumentName')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete <strong id="deleteDocName"></strong>?
            </div>
            <div class="modal-footer">
                <form asp-action="DeleteDocument" method="post">
                    <input type="hidden" name="id" id="deleteDocId" />
                    <button type="submit" class="btn btn-danger">Delete</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(function () {
            $("#documentsTable").DataTable({
                "responsive": true,
                "autoWidth": false,
                "order": [[4, "desc"]] // Sort by upload date descending
            });
        });

        function confirmDelete(id, name) {
            $('#deleteDocId').val(id);
            $('#deleteDocName').text(name);
            $('#deleteModal').modal('show');
        }
    </script>
}
